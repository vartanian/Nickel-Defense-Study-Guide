<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Coach's Guide to the Nickel Defense</title>
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A thematic, single-page dashboard structure was chosen over a linear document format to create a more engaging and explorable "playbook" experience. The user flow is guided by top-level navigation, allowing them to jump directly into core concepts (Intro), the specific position (Nickel Back deep-dive), practical application (Drills), or context (History). This structure facilitates easier learning and reference, as a parent or player can quickly access the section most relevant to their immediate questions (e.g., "What's my run responsibility?") without scrolling through unrelated content. Key interactions, like the Run/Pass toggle, are central to the design, allowing for direct comparison of the Nickel Back's dual roles, which is the most critical concept to grasp. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Base defensive personnel vs. Nickel personnel. -> Goal: Inform. -> Viz/Method: Interactive HTML/JS diagram showing a player substitution. -> Interaction: Button click animates the swap. -> Justification: Visually demonstrates the core concept of the formation change in a simple, memorable way. -> Library: Vanilla JS.
        - Report Info: Ideal attributes of a Nickel Back. -> Goal: Inform/Organize. -> Viz/Method: Radar chart. -> Interaction: Hover tooltips. -> Justification: A radar chart effectively displays multiple key skill metrics for a single role, showing the "shape" of an ideal player. -> Library: Chart.js (Canvas).
        - Report Info: Nickel Back's dual responsibilities. -> Goal: Compare. -> Viz/Method: Two interactive content blocks with associated HTML/JS diagrams. -> Interaction: Toggling between "Run Defense" and "Pass Coverage" views. -> Justification: This is the most crucial interactive element. It directly compares the two primary, and very different, jobs of the position, reinforcing the hybrid nature of the role. -> Library: Vanilla JS.
        - Report Info: Historical rise of the Nickel defense. -> Goal: Show Change. -> Viz/Method: Line chart. -> Interaction: Hover tooltips. -> Justification: A line chart is the clearest way to show a trend over time, emphasizing the formation's growing importance in the modern game. -> Library: Chart.js (Canvas).
        - Report Info: Player drills. -> Goal: Organize/Inform. -> Viz/Method: Interactive flip cards. -> Interaction: Clicking a card reveals details. -> Justification: Flip cards are an engaging way to present discrete packets of information without cluttering the initial view. -> Library: Vanilla JS/CSS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&family=Roboto:wght@400;500&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #FDF8F0;
            color: #4A4A4A;
        }
        h1, h2, h3 {
            font-family: 'Roboto Slab', serif;
        }
        .nav-link {
            transition: color 0.3s, border-color 0.3s;
        }
        .nav-link.active {
            color: #4A6C6F;
            border-bottom-color: #4A6C6F;
        }
        .nav-link:hover {
            color: #4A6C6F;
        }
        .player-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            transition: all 0.5s ease-in-out;
        }
        .dl { background-color: #B4A08D; color: white; }
        .lb { background-color: #8C7A6B; color: white; }
        .db { background-color: #4A6C6F; color: white; }
        .out { transform: translateY(100px) scale(0.5); opacity: 0; }
        .in { transform: translateY(0) scale(1); opacity: 1; }
        .drill-card-inner {
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .drill-card.flipped .drill-card-inner {
            transform: rotateY(180deg);
        }
        .drill-card-front, .drill-card-back {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        .drill-card-back {
            transform: rotateY(180deg);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
         @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A6C6F;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4A6C6F;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.visible {
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased">

    <div id="message-box" class="message-box hidden"></div>

    <header class="bg-[#FDF8F0]/80 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-200">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-[#4A6C6F]">The Nickel Playbook</h1>
            <div class="hidden md:flex space-x-8">
                <a href="#intro" class="nav-link text-gray-600 border-b-2 border-transparent pb-1">Intro</a>
                <a href="#nickelback" class="nav-link text-gray-600 border-b-2 border-transparent pb-1">The Nickel Back</a>
                <a href="#drills" class="nav-link text-gray-600 border-b-2 border-transparent pb-1">Drills</a>
                <a href="#history" class="nav-link text-gray-600 border-b-2 border-transparent pb-1">History</a>
                <a href="#ai-film-room" class="nav-link text-gray-600 border-b-2 border-transparent pb-1">AI Film Room</a>
            </div>
            <div class="md:hidden flex items-center">
                <button id="mobile-menu-btn" class="text-gray-600 focus:outline-none">
                    <span class="text-3xl">&#9776;</span>
                </button>
            </div>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden bg-[#FDF8F0] py-4">
            <a href="#intro" class="block py-2 px-6 text-gray-700 hover:bg-gray-200">Intro</a>
            <a href="#nickelback" class="block py-2 px-6 text-gray-700 hover:bg-gray-200">The Nickel Back</a>
            <a href="#drills" class="block py-2 px-6 text-gray-700 hover:bg-gray-200">Drills</a>
            <a href="#history" class="block py-2 px-6 text-gray-700 hover:bg-gray-200">History</a>
            <a href="#ai-film-room" class="block py-2 px-6 text-gray-700 hover:bg-gray-200">AI Film Room</a>
        </div>
    </header>

    <main class="container mx-auto px-6 py-12">
        <section id="intro" class="mb-20 text-center">
            <h2 class="text-4xl font-bold mb-4">Welcome to the Film Room</h2>
            <p class="max-w-3xl mx-auto text-lg text-gray-700 mb-12">Alright, listen up. Football is a game of adjustments. The offense is always trying to create mismatches, and our job on defense is to take them away. That's where the Nickel defense comes in. It's not just a formation; it's a philosophy built on speed, versatility, and intelligent football. This guide will break it all down for you. Let's get to work.</p>

            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h3 class="text-2xl font-bold mb-2">What is the Nickel Defense?</h3>
                <p class="mb-6">It's simple: we trade size for speed. In our base 4-3 defense, we have 4 defensive linemen, 3 linebackers, and 4 defensive backs. When the offense brings in an extra receiver, we need to match their speed. So, we bring in an extra defensive backâ€”the fifth one, hence the name "Nickel." We typically take out a linebacker to do this. Press the button below to see the swap.</p>
                
                <div class="flex justify-center items-center h-48 relative overflow-hidden mb-4">
                    <div id="formation-container" class="flex items-end space-x-4">
                        <div class="player-circle dl">DL</div>
                        <div class="player-circle dl">DL</div>
                        <div class="player-circle dl">DL</div>
                        <div class="player-circle dl">DL</div>
                        <div id="player-out" class="player-circle lb in">LB</div>
                        <div class="player-circle lb">LB</div>
                        <div class="player-circle lb">LB</div>
                        <div id="player-in" class="player-circle db out absolute bottom-0">NB</div>
                    </div>
                </div>
                <button id="swap-btn" class="bg-[#4A6C6F] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#3E5A5C] transition-colors">Go Nickel</button>
            </div>
        </section>

        <section id="nickelback" class="mb-20">
            <h2 class="text-3xl font-bold text-center mb-12">The Nickel Back: The Hybrid Defender</h2>
            <p class="text-center max-w-3xl mx-auto text-lg mb-12">The Nickel Back (NB) is the heart of this defense. This isn't a position for just any corner or safety. He has to be a unique blend of player: tough enough to take on pulling guards in the run game, but agile and fast enough to cover the quickest slot receivers man-to-man. He is a linebacker and a defensive back rolled into one. This chart shows the key attributes that make an elite Nickel Back.</p>

            <div class="bg-white p-8 rounded-lg shadow-lg mb-12">
                <h3 class="text-2xl font-bold mb-6 text-center">Profile of an Elite Nickel Back</h3>
                <div class="chart-container">
                    <canvas id="attributesChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-8 rounded-lg shadow-lg">
                <h3 class="text-2xl font-bold mb-6 text-center">Run Game vs. Pass Game Responsibilities</h3>
                <p class="text-center text-gray-600 mb-8">This is where the rubber meets the road. The Nickel Back's job changes dramatically depending on the play call. Use the buttons below to switch between his responsibilities against the run and the pass, and watch how his assignment changes on the field diagram.</p>
                <div class="flex justify-center space-x-4 mb-8">
                    <button id="run-btn" class="role-btn bg-[#4A6C6F] text-white font-bold py-2 px-6 rounded-lg">Stopping the Run</button>
                    <button id="pass-btn" class="role-btn bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg">Pass Coverage</button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div id="run-content">
                        <h4 class="text-xl font-bold mb-4 text-[#4A6C6F]">Run Defense: A Force Player</h4>
                        <ul class="space-y-3 list-disc list-inside text-gray-700">
                            <li><strong>Set the Edge:</strong> On outside runs, the Nickel Back is often the "force" player. His job is to attack the ball carrier and force them back inside towards the linebackers and defensive line. He cannot let the runner get outside of him.</li>
                            <li><strong>Fill the Alley:</strong> He must be aggressive in filling running lanes ("alleys") between the tackle and the receivers. This requires courage and proper tackling technique against bigger players.</li>
                            <li><strong>Shed Blocks:</strong> He'll be blocked by tight ends and wide receivers. He must be physical enough to shed those blocks and make a play on the ball.</li>
                        </ul>
                    </div>
                    <div id="pass-content" class="hidden">
                        <h4 class="text-xl font-bold mb-4 text-[#4A6C6F]">Pass Coverage: A Lockdown Defender</h4>
                         <ul class="space-y-3 list-disc list-inside text-gray-700">
                            <li><strong>Man Coverage:</strong> Most often, he'll be in man-to-man coverage against the slot receiver, who is usually the quickest player on the offense. This requires elite agility and footwork.</li>
                            <li><strong>Zone Coverage:</strong> In zone schemes, he's typically responsible for the "curl/flat" area, defending against short passes to the sideline and intermediate curl routes.</li>
                            <li><strong>Blitzing:</strong> The Nickel Back is a dangerous blitzer. Coming off the edge, he is often unblocked and can disrupt the quarterback's timing or create sacks and fumbles.</li>
                        </ul>
                    </div>

                    <div class="bg-green-800 h-80 relative flex items-center justify-center rounded-lg p-4 border-4 border-white">
                        <div class="absolute top-0 bottom-0 left-1/2 w-0.5 bg-white/50"></div>
                        <div class="absolute top-1/4 bottom-1/4 left-1/4 w-0.5 bg-white/50"></div>
                        <div class="absolute top-1/4 bottom-1/4 right-1/4 w-0.5 bg-white/50"></div>
                        
                        <div id="nb-player-diagram" class="player-circle db absolute" style="top: 50%; left: 30%; transform: translate(-50%, -50%); transition: all 0.8s ease-in-out;">NB</div>
                        <div class="text-white absolute top-1/2" style="left: 60%; transform: translateY(-50%);">
                            <span class="text-4xl font-bold" id="ball-carrier">RB â†’</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="drills" class="mb-20">
            <h2 class="text-3xl font-bold text-center mb-12">Mastering the Craft: Drills</h2>
            <p class="text-center max-w-3xl mx-auto text-lg mb-12">Talent is one thing, but technique is what makes a player great. These drills are essential for any aspiring Nickel Back. They build the footwork, agility, and tackling fundamentals required to excel at this demanding position. Focus on perfect reps, not just going through the motions.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="drill-card h-64 rounded-lg shadow-lg cursor-pointer perspective">
                    <div class="drill-card-inner relative w-full h-full">
                        <div class="drill-card-front absolute w-full h-full bg-white rounded-lg p-6 flex flex-col justify-center items-center text-center">
                            <h3 class="text-xl font-bold mb-2">Backpedal & Break</h3>
                            <p class="text-gray-600">The foundation of pass coverage. Click to learn more.</p>
                        </div>
                        <div class="drill-card-back absolute w-full h-full bg-[#4A6C6F] text-white rounded-lg p-6">
                            <h4 class="font-bold mb-2">Technique:</h4>
                            <p class="text-sm">Player backpedals for 5-10 yards, keeping a low center of gravity. On a coach's command, he plants his foot and drives forward at a 45-degree angle. Focus on explosive, efficient movement with no wasted steps.</p>
                        </div>
                    </div>
                </div>
                 <div class="drill-card h-64 rounded-lg shadow-lg cursor-pointer perspective">
                    <div class="drill-card-inner relative w-full h-full">
                        <div class="drill-card-front absolute w-full h-full bg-white rounded-lg p-6 flex flex-col justify-center items-center text-center">
                            <h3 class="text-xl font-bold mb-2">3-Cone Weave</h3>
                            <p class="text-gray-600">Develops hip fluidity and change-of-direction. Click to learn more.</p>
                        </div>
                        <div class="drill-card-back absolute w-full h-full bg-[#4A6C6F] text-white rounded-lg p-6">
                            <h4 class="font-bold mb-2">Technique:</h4>
                            <p class="text-sm">Set up 3 cones in an 'L' shape. Player sprints to the first cone, backpedals around the second, and weaves around the third. This drill simulates navigating through traffic and staying with shifty receivers.</p>
                        </div>
                    </div>
                </div>
                 <div class="drill-card h-64 rounded-lg shadow-lg cursor-pointer perspective">
                    <div class="drill-card-inner relative w-full h-full">
                        <div class="drill-card-front absolute w-full h-full bg-white rounded-lg p-6 flex flex-col justify-center items-center text-center">
                            <h3 class="text-xl font-bold mb-2">Open-Field Tackling</h3>
                            <p class="text-gray-600">Crucial for stopping plays in space. Click to learn more.</p>
                        </div>
                        <div class="drill-card-back absolute w-full h-full bg-[#4A6C6F] text-white rounded-lg p-6">
                            <h4 class="font-bold mb-2">Technique:</h4>
                            <p class="text-sm">Set up a 10x10 yard box. A ball carrier tries to run past the defender. The defender must break down, keep his feet moving, and use proper "head up, wrap and drive" form. This is about control, not just big hits.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="history" class="mb-12">
            <h2 class="text-3xl font-bold text-center mb-12">The Rise of the Nickel</h2>
            <p class="text-center max-w-3xl mx-auto text-lg mb-12">The Nickel defense wasn't always a staple. It was an innovation born out of necessity in the 1970s to combat the rise of modern passing offenses. As you can see from the chart below, its usage has exploded over the decades. Today, it's the most common defensive formation in the NFL, a testament to its effectiveness in the modern game.</p>
             <div class="bg-white p-8 rounded-lg shadow-lg">
                <h3 class="text-2xl font-bold mb-6 text-center">NFL Defensive Snaps in Nickel Formation (%)</h3>
                <div class="chart-container h-96">
                    <canvas id="historyChart"></canvas>
                </div>
            </div>
        </section>

        <section id="ai-film-room" class="mb-12">
            <h2 class="text-3xl font-bold text-center mb-12">AI Film Room âœ¨</h2>
            <p class="text-center max-w-3xl mx-auto text-lg mb-12">This is your new secret weapon. Use the AI Playbook Assistant to get tactical advice or the Drill Generator to create custom practice plans. Think of it as having an offensive coordinator on your side of the ball, but for defense.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- AI Playbook Assistant -->
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-bold mb-4">AI Playbook Assistant âœ¨</h3>
                    <p class="mb-4 text-gray-600">Ask a question about the Nickel defense and get an expert's take. <br>Example: "How do we adjust to a motion receiver from the slot?"</p>
                    <textarea id="playbook-input" class="w-full h-24 p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4A6C6F] resize-none" placeholder="Enter your tactical question here..."></textarea>
                    <button id="playbook-btn" class="mt-4 w-full bg-[#4A6C6F] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#3E5A5C] transition-colors flex items-center justify-center">
                        <span id="playbook-btn-text">Get Tactical Advice</span>
                        <div id="playbook-spinner" class="loading-spinner hidden"></div>
                    </button>
                    <div id="playbook-response" class="mt-6 p-4 rounded-lg bg-gray-100 text-gray-800 hidden"></div>
                </div>
                
                <!-- Drill Generator -->
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-bold mb-4">Drill Generator âœ¨</h3>
                    <p class="mb-4 text-gray-600">Tell the AI what skill you want to practice and it will generate a drill for you. <br>Example: "I want a drill to improve my tackling in the open field."</p>
                    <textarea id="drill-input" class="w-full h-24 p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4A6C6F] resize-none" placeholder="Describe the drill you want to create..."></textarea>
                    <button id="drill-btn" class="mt-4 w-full bg-[#4A6C6F] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#3E5A5C] transition-colors flex items-center justify-center">
                        <span id="drill-btn-text">Generate Drill</span>
                        <div id="drill-spinner" class="loading-spinner hidden"></div>
                    </button>
                    <div id="drill-response" class="mt-6 p-4 rounded-lg bg-gray-100 text-gray-800 hidden"></div>
                </div>

                <!-- AI Scout Report -->
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-bold mb-4">AI Scout Report âœ¨</h3>
                    <p class="mb-4 text-gray-600">Enter a description of the opposing offense to get a tactical scout report. <br>Example: "They have a fast-paced, spread offense that loves to run quick slants."</p>
                    <textarea id="scout-input" class="w-full h-24 p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4A6C6F] resize-none" placeholder="Enter opponent details here..."></textarea>
                    <button id="scout-btn" class="mt-4 w-full bg-[#4A6C6F] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#3E5A5C] transition-colors flex items-center justify-center">
                        <span id="scout-btn-text">Generate Scout Report</span>
                        <div id="scout-spinner" class="loading-spinner hidden"></div>
                    </button>
                    <div id="scout-response" class="mt-6 p-4 rounded-lg bg-gray-100 text-gray-800 hidden"></div>
                </div>

                <!-- Audio Coach -->
                <div class="bg-white p-8 rounded-lg shadow-lg">
                    <h3 class="text-2xl font-bold mb-4">Audio Coach âœ¨</h3>
                    <p class="mb-4 text-gray-600">Type a coaching point to hear it spoken by the AI in a coach's voice. <br>Example: "Keep your head on a swivel. Don't take your eyes off the ball."</p>
                    <textarea id="tts-input" class="w-full h-24 p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4A6C6F] resize-none" placeholder="Enter your coaching point here..."></textarea>
                    <button id="tts-btn" class="mt-4 w-full bg-[#4A6C6F] text-white font-bold py-2 px-6 rounded-lg hover:bg-[#3E5A5C] transition-colors flex items-center justify-center">
                        <span id="tts-btn-text">Play Coaching Point</span>
                        <div id="tts-spinner" class="loading-spinner hidden"></div>
                    </button>
                    <audio id="tts-audio" class="mt-4 w-full hidden" controls></audio>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-6 text-center">
            <h3 class="text-2xl font-bold font-['Roboto_Slab'] mb-2">Coach's Final Word</h3>
            <p class="max-w-3xl mx-auto">Remember, understanding the scheme is half the battle. The other half is execution, hard work, and heart. Take what you've learned here, get on the field, and compete. I'm proud of the effort. Now go make a play.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const swapBtn = document.getElementById('swap-btn');
            const playerOut = document.getElementById('player-out');
            const playerIn = document.getElementById('player-in');
            let isNickel = false;
            swapBtn.addEventListener('click', () => {
                if (isNickel) {
                    playerOut.classList.remove('out');
                    playerOut.classList.add('in');
                    playerIn.classList.remove('in');
                    playerIn.classList.add('out');
                    swapBtn.textContent = 'Go Nickel';
                } else {
                    playerOut.classList.remove('in');
                    playerOut.classList.add('out');
                    playerIn.classList.remove('out');
                    playerIn.classList.add('in');
                    swapBtn.textContent = 'Go Base 4-3';
                }
                isNickel = !isNickel;
            });

            const runBtn = document.getElementById('run-btn');
            const passBtn = document.getElementById('pass-btn');
            const runContent = document.getElementById('run-content');
            const passContent = document.getElementById('pass-content');
            const nbPlayerDiagram = document.getElementById('nb-player-diagram');
            const ballCarrier = document.getElementById('ball-carrier');
            
            runBtn.addEventListener('click', () => {
                runBtn.classList.add('bg-[#4A6C6F]', 'text-white');
                runBtn.classList.remove('bg-gray-200', 'text-gray-700');
                passBtn.classList.add('bg-gray-200', 'text-gray-700');
                passBtn.classList.remove('bg-[#4A6C6F]', 'text-white');

                runContent.classList.remove('hidden');
                passContent.classList.add('hidden');
                
                nbPlayerDiagram.style.top = '50%';
                nbPlayerDiagram.style.left = '45%';
                ballCarrier.textContent = 'RB â†’';
            });
            
            passBtn.addEventListener('click', () => {
                passBtn.classList.add('bg-[#4A6C6F]', 'text-white');
                passBtn.classList.remove('bg-gray-200', 'text-gray-700');
                runBtn.classList.add('bg-gray-200', 'text-gray-700');
                runBtn.classList.remove('bg-[#4A6C6F]', 'text-white');

                passContent.classList.remove('hidden');
                runContent.classList.add('hidden');
                
                nbPlayerDiagram.style.top = '25%';
                nbPlayerDiagram.style.left = '30%';
                ballCarrier.textContent = 'WR â†±';
            });
            
            const drillCards = document.querySelectorAll('.drill-card');
            drillCards.forEach(card => {
                card.addEventListener('click', () => {
                    card.classList.toggle('flipped');
                });
            });

            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('section');

            window.addEventListener('scroll', () => {
                let current = '';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (pageYOffset >= sectionTop - 100) {
                        current = section.getAttribute('id');
                    }
                });

                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === `#${current}`) {
                        link.classList.add('active');
                    }
                });
            });

            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');

            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
            
            document.querySelectorAll('#mobile-menu a').forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.add('hidden');
                });
            });

            const attributesChartCtx = document.getElementById('attributesChart').getContext('2d');
            new Chart(attributesChartCtx, {
                type: 'radar',
                data: {
                    labels: ['Agility', 'Speed', 'Tackling', 'Coverage Skill', 'Football IQ', 'Toughness'],
                    datasets: [{
                        label: 'Elite Nickel Back',
                        data: [9, 8, 7, 9, 10, 8],
                        backgroundColor: 'rgba(74, 108, 111, 0.2)',
                        borderColor: 'rgba(74, 108, 111, 1)',
                        pointBackgroundColor: 'rgba(74, 108, 111, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(74, 108, 111, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            pointLabels: { font: { size: 14 } },
                            min: 0,
                            max: 10,
                            ticks: {
                                stepSize: 2,
                                backdropColor: 'rgba(253, 248, 240, 1)',
                                color: '#4A4A4A'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });

            const historyChartCtx = document.getElementById('historyChart').getContext('2d');
            new Chart(historyChartCtx, {
                type: 'line',
                data: {
                    labels: ['1980', '1990', '2000', '2010', '2020s'],
                    datasets: [{
                        label: '% of Snaps in Nickel',
                        data: [15, 25, 40, 55, 65],
                        fill: true,
                        backgroundColor: 'rgba(74, 108, 111, 0.2)',
                        borderColor: 'rgba(74, 108, 111, 1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%'
                                }
                            }
                        }
                    }
                }
            });

            const playbookInput = document.getElementById('playbook-input');
            const playbookBtn = document.getElementById('playbook-btn');
            const playbookBtnText = document.getElementById('playbook-btn-text');
            const playbookSpinner = document.getElementById('playbook-spinner');
            const playbookResponse = document.getElementById('playbook-response');
            
            const drillInput = document.getElementById('drill-input');
            const drillBtn = document.getElementById('drill-btn');
            const drillBtnText = document.getElementById('drill-btn-text');
            const drillSpinner = document.getElementById('drill-spinner');
            const drillResponse = document.getElementById('drill-response');

            const scoutInput = document.getElementById('scout-input');
            const scoutBtn = document.getElementById('scout-btn');
            const scoutBtnText = document.getElementById('scout-btn-text');
            const scoutSpinner = document.getElementById('scout-spinner');
            const scoutResponse = document.getElementById('scout-response');

            const ttsInput = document.getElementById('tts-input');
            const ttsBtn = document.getElementById('tts-btn');
            const ttsBtnText = document.getElementById('tts-btn-text');
            const ttsSpinner = document.getElementById('tts-spinner');
            const ttsAudio = document.getElementById('tts-audio');

            const messageBox = document.getElementById('message-box');

            function showMessage(message, duration = 3000) {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden');
                messageBox.classList.add('visible');
                setTimeout(() => {
                    messageBox.classList.remove('visible');
                    setTimeout(() => {
                        messageBox.classList.add('hidden');
                    }, 500);
                }, duration);
            }

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            // A generic async function to handle API calls with exponential backoff
            async function fetchWithExponentialBackoff(payload, apiUrl, retries = 5) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status === 429) {
                            if (i < retries - 1) {
                                const delay = Math.pow(2, i) * 1000;
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue;
                            }
                        }
                        return response;
                    } catch (error) {
                        if (i < retries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw error;
                    }
                }
                throw new Error('Max retries exceeded.');
            }

            // A reusable function to handle the entire API request workflow for the buttons
            async function handleApiRequest(inputEl, buttonEl, buttonTextEl, spinnerEl, responseEl, callback) {
                const prompt = inputEl.value.trim();
                if (!prompt) return;

                buttonEl.disabled = true;
                buttonTextEl.classList.add('hidden');
                spinnerEl.classList.remove('hidden');
                responseEl.classList.add('hidden');

                try {
                    await callback(prompt);
                } catch (error) {
                    console.error('API request failed:', error);
                    responseEl.innerHTML = "Sorry, coach. I couldn't get a response. Something's not working right in the film room. Try again later.";
                    responseEl.classList.remove('hidden');
                } finally {
                    buttonEl.disabled = false;
                    buttonTextEl.classList.remove('hidden');
                    spinnerEl.classList.add('hidden');
                }
            }

            // Function for processing standard text responses
            function processTextResponse(result, responseEl) {
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Couldn't generate a response. Please try again.";
                responseEl.innerHTML = text.replace(/\n/g, '<br>');
                responseEl.classList.remove('hidden');
            }

            // Function for processing structured JSON responses
            function processStructuredResponse(result, responseEl) {
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error("Invalid JSON response received.");
                }
                const drill = JSON.parse(jsonText);

                let html = `<h4 class="font-bold text-[#4A6C6F] mb-2">${drill.drillName}</h4>`;
                html += `<p class="mb-4 text-gray-700"><strong>Purpose:</strong> ${drill.purpose}</p>`;
                html += `<h5 class="font-bold mb-2">Steps:</h5>`;
                html += `<ol class="list-decimal list-inside space-y-2">`;
                drill.steps.forEach(step => {
                    html += `<li>${step}</li>`;
                });
                html += `</ol>`;

                responseEl.innerHTML = html;
                responseEl.classList.remove('hidden');
            }

            // Event listener for AI Playbook Assistant
            playbookBtn.addEventListener('click', () => {
                handleApiRequest(playbookInput, playbookBtn, playbookBtnText, playbookSpinner, playbookResponse, async (prompt) => {
                    const systemPrompt = "You are a highly experienced football coach specializing in the Nickel defense. Your responses should be tactical, professional, and confident, as if you're talking to a player in the film room. Use terms like 'listen up,' 'on the field,' and 'make a play' to maintain the persona. Keep responses concise and to the point, focused on clear instruction.";
                    const userQuery = `As a coach, answer this question about the Nickel defense: "${prompt}"`;
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };
                    const response = await fetchWithExponentialBackoff(payload, apiUrl);
                    const result = await response.json();
                    processTextResponse(result, playbookResponse);
                });
            });

            // Event listener for Drill Generator
            drillBtn.addEventListener('click', () => {
                handleApiRequest(drillInput, drillBtn, drillBtnText, drillSpinner, drillResponse, async (prompt) => {
                    const userQuery = `Generate a football drill that helps a Nickel Back improve on the following: "${prompt}". The response should be a JSON object with the following structure: { "drillName": "string", "purpose": "string", "steps": ["string", "string", "string"] }. Make sure the steps are a concise, ordered list of instructions.`;
                    const systemPrompt = "You are a football coach's assistant generating drills. The drills should be highly specific and instructional.";
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "drillName": { "type": "STRING" },
                                    "purpose": { "type": "STRING" },
                                    "steps": { "type": "ARRAY", "items": { "type": "STRING" } }
                                }
                            }
                        },
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };
                    const response = await fetchWithExponentialBackoff(payload, apiUrl);
                    const result = await response.json();
                    processStructuredResponse(result, drillResponse);
                });
            });

            // Event listener for AI Scout Report
            scoutBtn.addEventListener('click', () => {
                handleApiRequest(scoutInput, scoutBtn, scoutBtnText, scoutSpinner, scoutResponse, async (prompt) => {
                    const systemPrompt = "You are an elite football scout providing a tactical report. Your responses should be analytical, professional, and focus on scheme-specific recommendations for a Nickel defense. Use phrases like 'tendencies indicate' and 'recommendations for the Nickel defense' to maintain the persona. The report should be structured with clear sections for tendencies, key players, and recommendations.";
                    const userQuery = `Generate a scout report for an opposing offense with the following characteristics: "${prompt}".`;
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };
                    const response = await fetchWithExponentialBackoff(payload, apiUrl);
                    const result = await response.json();
                    processTextResponse(result, scoutResponse);
                });
            });

            // Helper function to convert base64 to ArrayBuffer
            function base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            // Helper function to convert PCM audio to WAV format
            function pcmToWav(pcmData, sampleRate) {
                const buffer = new ArrayBuffer(44 + pcmData.byteLength);
                const view = new DataView(buffer);

                // RIFF identifier
                writeString(view, 0, 'RIFF');
                // file size
                view.setUint32(4, 36 + pcmData.byteLength, true);
                // RIFF type
                writeString(view, 8, 'WAVE');
                // format chunk identifier
                writeString(view, 12, 'fmt ');
                // format chunk length
                view.setUint32(16, 16, true);
                // sample format (1 = PCM)
                view.setUint16(20, 1, true);
                // channel count
                view.setUint16(22, 1, true);
                // sample rate
                view.setUint32(24, sampleRate, true);
                // byte rate (sample rate * block align)
                view.setUint32(28, sampleRate * 2, true);
                // block align (channel count * bytes per sample)
                view.setUint16(32, 2, true);
                // bits per sample
                view.setUint16(34, 16, true);
                // data chunk identifier
                writeString(view, 36, 'data');
                // data chunk length
                view.setUint32(40, pcmData.byteLength, true);

                // write the PCM samples
                let offset = 44;
                for (let i = 0; i < pcmData.length; i++, offset += 2) {
                    view.setInt16(offset, pcmData[i], true);
                }

                return new Blob([view], { type: 'audio/wav' });
            }

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            ttsBtn.addEventListener('click', async () => {
                const text = ttsInput.value.trim();
                if (!text) {
                    showMessage("First, type a coaching point into the box.");
                    return;
                }

                ttsBtn.disabled = true;
                ttsBtnText.classList.add('hidden');
                ttsSpinner.classList.remove('hidden');
                ttsAudio.classList.add('hidden');
                
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                try {
                    showMessage("Processing audio... one moment.");
                    const response = await fetchWithExponentialBackoff(payload, ttsApiUrl);
                    const result = await response.json();
                    
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                        
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);

                        ttsAudio.src = audioUrl;
                        ttsAudio.classList.remove('hidden');
                        ttsAudio.play();
                        showMessage("Audio ready! You can play it below.");
                    } else {
                        showMessage("Could not generate audio. Please try again.");
                        console.error("Invalid audio response:", result);
                    }
                } catch (error) {
                    console.error('Error fetching TTS audio:', error);
                    showMessage("Error generating audio. Check the console for details.");
                } finally {
                    ttsBtn.disabled = false;
                    ttsBtnText.classList.remove('hidden');
                    ttsSpinner.classList.add('hidden');
                }
            });
        });
    </script>

</body>
</html>
